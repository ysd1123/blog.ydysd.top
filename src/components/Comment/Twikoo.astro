---
import twikooCSS from 'twikoo/dist/twikoo.css?url'
import twikooPath from 'twikoo/dist/twikoo.nocss.js?url' // Using twikoo.min.js causes CSS loading failure after View Transitions
import { allLocales, base, defaultLocale, themeConfig } from '@/config'
import { twikooLocaleMap } from '@/i18n/config'

const { envId = '' } = themeConfig.comment.twikoo ?? {}
---

<!-- Class not working on twikoo div -->
<div class="no-heti mt-16">
  <div id="twikoo" />
</div>

<!-- Twikoo Script >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> -->
<script
  is:inline
  src={twikooPath}
></script>

<script
  is:inline
  define:vars={{
    allLocales,
    base,
    defaultLocale,
    envId,
    twikooLocaleMap,
    twikooCSS,
  }}
>
let twikooObserver = null
let twikooContainer = null

function setupTwikoo() {
  try {
    const currentPath = window.location.pathname

    // Remove locale prefix from path
    const localePattern = new RegExp(`\\/(${allLocales.join('|')})\\/`)
    const twikooPath = currentPath.replace(localePattern, '/')
    const pathWithoutBase = base && currentPath.startsWith(base)
      ? currentPath.slice(base.length)
      : currentPath

    // Determine language
    const matchedLang = Object.keys(twikooLocaleMap).find(code => pathWithoutBase.startsWith(`/${code}/`))
    const lang = matchedLang ?? defaultLocale

    twikoo.init({
      envId,
      el: '#twikoo',
      // region: 'ap-shanghai', // Specify for Tencent Cloud, omit for Vercel
      path: twikooPath,
      lang: twikooLocaleMap[lang],
    })
  }
  catch (error) {
    console.error('[Twikoo] Failed to initialize:', error)
  }
}

// Lazy load Twikoo when the container enters viewport
function lazySetupTwikoo() {
  twikooContainer = document.getElementById('twikoo')
  if (!twikooContainer) {
    return
  }

  if (!document.getElementById('twikoo-css')) {
    const link = document.createElement('link')
    link.id = 'twikoo-css'
    link.rel = 'stylesheet'
    link.href = twikooCSS
    document.head.appendChild(link)
  }

  twikooObserver = new IntersectionObserver((entries) => {
    if (entries.some(entry => entry.isIntersecting)) {
      setupTwikoo()
      twikooObserver?.disconnect()
    }
  }, { rootMargin: '500px' })

  twikooObserver.observe(twikooContainer)
}

function cleanupTwikoo() {
  twikooObserver?.disconnect()
  twikooObserver = null

  if (twikooContainer) {
    twikooContainer.innerHTML = ''
    twikooContainer = null
  }
}

document.addEventListener('astro:page-load', lazySetupTwikoo)
document.addEventListener('astro:before-swap', cleanupTwikoo)
</script>
