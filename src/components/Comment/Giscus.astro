---
import { base, defaultLocale, themeConfig } from '@/config'
import { giscusLocaleMap } from '@/i18n/config'

const {
  repo = '',
  repoId = '',
  category = '',
  categoryId = '',
  mapping = 'pathname',
  strict = '0',
  reactionsEnabled = '1',
  emitMetadata = '0',
  inputPosition = 'bottom',
} = themeConfig.comment.giscus ?? {}


const currentPath = Astro.url.pathname

// Determine language
const pathWithoutBase = base && currentPath.startsWith(base)
  ? currentPath.slice(base.length)
  : currentPath
const matchedLang = Object.keys(giscusLocaleMap).find(code => pathWithoutBase.startsWith(`/${code}/`))
const lang = (matchedLang ?? defaultLocale) as keyof typeof giscusLocaleMap

const giscusConfig = {
  base,
  repo,
  repoId,
  category,
  categoryId,
  mapping,
  strict,
  reactionsEnabled,
  emitMetadata,
  inputPosition,
  lang: giscusLocaleMap[lang],
}
---

<div
  id="giscus"
  class="giscus mt-16"
  data-config={JSON.stringify(giscusConfig)}
/>

<!-- Giscus Script >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> -->
<script>
let giscusContainer: HTMLElement | null = null

function getThemeUrl(base: string) {
  const isDark = document.documentElement.classList.contains('dark')
  const origin = window.location.origin

  return isDark
    ? `${origin}${base}/giscus/theme-dark.css`
    : `${origin}${base}/giscus/theme-light.css`
}

function updateGiscusTheme() {
  if (!giscusContainer || !giscusContainer.dataset.config) {
    return
  }

  const giscusWindow = giscusContainer.querySelector<HTMLIFrameElement>('iframe.giscus-frame')?.contentWindow
  if (!giscusWindow) {
    return
  }

  try {
    const { base } = JSON.parse(giscusContainer.dataset.config)
    giscusWindow.postMessage(
      { giscus: { setConfig: { theme: getThemeUrl(base) } } },
      'https://giscus.app',
    )
  }
  catch (error) {
    console.error('[Giscus] Failed to update theme:', error)
  }
}

function setupGiscus() {
  giscusContainer = document.getElementById('giscus')
  if (!giscusContainer || !giscusContainer.dataset.config) {
    return
  }

  giscusContainer.innerHTML = ''

  try {
    const config = JSON.parse(giscusContainer.dataset.config)
    const { base, category, ...restConfig } = config

    const dataAttributes: Record<string, string> = {
      ...restConfig,
      ...(category && { category }),
      theme: getThemeUrl(base),
    }

    const script = document.createElement('script')
    script.crossOrigin = 'anonymous'
    script.async = true
    Object.assign(script.dataset, dataAttributes)
    script.src = 'https://giscus.app/client.js'
    giscusContainer.appendChild(script)
  }
  catch (error) {
    console.error('[Giscus] Failed to initialize:', error)
  }

  document.addEventListener('theme-changed', updateGiscusTheme)
}

function cleanupGiscus() {
  document.removeEventListener('theme-changed', updateGiscusTheme)

  if (giscusContainer) {
    giscusContainer.innerHTML = ''
    giscusContainer = null
  }
}

document.addEventListener('astro:page-load', setupGiscus)
document.addEventListener('astro:before-swap', cleanupGiscus)
</script>
